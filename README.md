# BATCH-FLEX
BatchFLEX: Comprehensive software for assessing and correcting batch effects, comparing batch correction methods, and exporting corrected matrices for downstream analysis

# Introduction
BatchFLEX is an intuitive Shiny App that can be viewed as a web interface through shiny.io or accessed locally by downloading and installing an app.R or docker container, or by installing an R-package. BatchFLEX is designed with a clean user interface and easy to follow steps to prompt users to input a data matrix and meta file, to select and implement the desired method of batch correction, to assess the impact of the batch correction method using side-by-side comparisons of pre and post corrected graphs and statistics, and finally to export a corrected matrix and accompanying diagnostics for downstream analysis. The intuitive user interface allows for hands-on evaluation and selection of the most optimal batch correction method for any dataset and for users with any background. BatchFLEX is the most comprehensive batch correction and evaluation tool and can easily be implemented into any pipeline using the R-package wrapper. Notable features of BatchFLEX include implementation of a wide variety of batch correction methods such as ComBat, ComBatSeq, Harman, LIMMA, RUVg, and Mean centering, incorporation of multiple different types of evaluation methods such as PCA, cluster analysis, gene-variable association analysis, scree plots, SVA, uMAP, RLE, boxplots, and heatmaps, and inclusion of a simple and comprehensive export feature for use of corrected matrices in downstream analysis and for record keeping to justify the correction method selection for publications. 

An overview of the BatchFLEX suite of tools can be found on our GitHub page (https://github.com/shawlab-moffitt/BATCHFLEX), which includes source code, example data, and an installation guide. Additionally, BatchFLEX can be accessed through shiny.io at (https://shawlab-moffitt.shinyapps.io/batch_flex/). 

# Installation
The BatchFLEX suite can be downloaded (cloned) and installed through the GitHub repository. The downloaded file can be unzipped to a destination folder, which should be set as the working directory or file path. Of note, some of the example files (e.g., gene set files) use relative paths, so the program may fail to identify the file if a working directory is not properly set. The suite was developed in R version 4.1. 

*	**Install BatchFLEX suite GitHub repository**
    * git clone https://github.com/shawlab-moffitt/BATCHFLEX

*	**Download and unzip repository https://github.com/shawlab-moffitt/BATCHFLEX**
    * Set working directory to BatchFLEX folder
    * Install required R packages
    * Suite of tools was built on R version 4.2
    * R script for package installation is provided in the “1-Getting_Started” folder

# Load Example Data
BatchFLEX includes a sample dataset within the Shiny app, which was generated by harmonizing expression data originating from the ImmGen project. Users can access the sample dataset by simply selecting the “Load Example Data” button. In this dataset, study is considered the batch effect and cell type is considered the variable of interest. 

<img width="288" alt="image" src="https://github.com/shawlab-moffitt/BATCH-FLEX-ShinyApp/assets/89986836/c99b05b0-a054-4367-b9eb-8045213e0df5">

# Input User Data
BatchFLEX provides an intuitive method for users to input and preview a matrix and meta file and to apply common preprocessing steps such as log 2 + 1 transformation, quantile normalization, Trimmed Mean of the M-values, or UpperQuartile normalization. 

<img width="276" alt="image" src="https://github.com/shawlab-moffitt/BATCH-FLEX-ShinyApp/assets/89986836/70ab2e85-67b5-4767-9b2d-cbed56156ac1">

Key Input Files
1. Required Files
    * Gene expression file where the gene symbols are in the first column and the sample names are in the first-row header.
    * Meta information file that consists of a matrix with the first column the sample name. The remaining columns should contain the batch information and any variables of interest.
    	
2. Optional Files
    * Housekeeping Gene List is an optional housekeeping gene list for the RUVg correction method. The gene list should be a tab separated file with a single column of genes. 
    * Gene set of Interest is an optional list of genes for a pathway of interest that can be used with the gene set enrichment analysis. 

Matrix and meta files should be formatted similarly to the example datasets shown below. The matrix file should contain genes in the first column and sample IDs in the first row. The meta file should contain sample IDs in the first column and any accompanying meta information in subsequent columns. The sample IDs should match between the matrix and meta files. The meta file should include at least one column of known technical effects and at least one column of known biological effects. BatchFLEX defaults to selecting the second column of the meta file as the batch effect and the third column as the variable of interest. This can easily be changed by the user by simply selecting a different column using the dropdown menus, however, if only a single batch effect is being corrected, having this in the second column can save the user a lot of unnecessary clicking. 
![image](https://github.com/shawlab-moffitt/BATCH-FLEX-ShinyApp/assets/89986836/07fde086-9896-4999-8d95-95b2ae7a0df0)





